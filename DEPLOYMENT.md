# ðŸš€ Deployment Guide

This guide covers deploying the Movie Recommendation System to various platforms.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Local Production Setup](#local-production-setup)
- [Deploy to Render](#deploy-to-render)
- [Deploy to Heroku](#deploy-to-heroku)
- [Deploy to AWS](#deploy-to-aws)
- [Deploy with Docker](#deploy-with-docker)
- [Database Configuration](#database-configuration)
- [Static Files](#static-files)
- [Environment Variables](#environment-variables)
- [Troubleshooting](#troubleshooting)

## Prerequisites

Before deploying, ensure you have:

- [ ] Python 3.10+ installed
- [ ] Git repository set up
- [ ] All tests passing locally
- [ ] Database backup (if applicable)
- [ ] Environment variables configured
- [ ] Static files collected

## Local Production Setup

### 1. Configure Environment

```bash
# Copy environment template
cp .env.example .env

# Edit .env file
SECRET_KEY=your-very-secure-secret-key-here
DEBUG=False
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com
```

### 2. Install Dependencies

```bash
pip install -r requirements.txt
```

### 3. Collect Static Files

```bash
python manage.py collectstatic --noinput
```

### 4. Run with Gunicorn

```bash
gunicorn movie_recommendation.wsgi:application --bind 0.0.0.0:8000
```

## Deploy to Render

Render is recommended for easy deployment with free tier support.

### Step-by-Step

1. **Create `render.yaml`** in project root:

```yaml
services:
  - type: web
    name: movie-recommendation
    env: python
    buildCommand: |
      pip install -r requirements.txt
      python manage.py collectstatic --noinput
      python manage.py migrate
    startCommand: gunicorn movie_recommendation.wsgi:application
    envVars:
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: False
      - key: PYTHON_VERSION
        value: 3.10.0
      - key: DATABASE_URL
        fromDatabase:
          name: movie-recommendation-db
          property: connectionString
    plan: free

databases:
  - name: movie-recommendation-db
    plan: free
    databaseName: movie_recommendation
    user: movie_user
```

2. **Push to GitHub**

```bash
git add .
git commit -m "Prepare for Render deployment"
git push origin main
```

3. **Connect to Render**
   - Go to [render.com](https://render.com)
   - Click "New +" â†’ "Blueprint"
   - Connect your GitHub repository
   - Render will auto-detect `render.yaml`

4. **Set Environment Variables** in Render Dashboard:
   ```
   SECRET_KEY=<auto-generated>
   DEBUG=False
   ALLOWED_HOSTS=your-app.onrender.com
   ```

5. **Deploy!**
   - Click "Apply"
   - Wait for deployment to complete
   - Your app will be available at `https://your-app.onrender.com`

### Render Commands

```bash
# Manual deployment trigger
git push origin main

# View logs
# Access via Render dashboard â†’ Logs

# Shell access
# Access via Render dashboard â†’ Shell
```

## Deploy to Heroku

### Prerequisites

```bash
# Install Heroku CLI
# Visit: https://devcenter.heroku.com/articles/heroku-cli

# Login to Heroku
heroku login
```

### Deployment Steps

1. **Create `Procfile`** in project root:

```
web: gunicorn movie_recommendation.wsgi:application --log-file -
release: python manage.py migrate
```

2. **Create `runtime.txt`**:

```
python-3.10.13
```

3. **Initialize Git and Heroku**

```bash
# Create Heroku app
heroku create your-app-name

# Add PostgreSQL
heroku addons:create heroku-postgresql:mini

# Set environment variables
heroku config:set SECRET_KEY="your-secret-key"
heroku config:set DEBUG=False
heroku config:set ALLOWED_HOSTS=your-app-name.herokuapp.com
```

4. **Deploy**

```bash
git push heroku main
```

5. **Migrate Database**

```bash
heroku run python manage.py migrate
heroku run python manage.py collectstatic --noinput
```

6. **Open Application**

```bash
heroku open
```

### Heroku Useful Commands

```bash
# View logs
heroku logs --tail

# Run Django shell
heroku run python manage.py shell

# Scale dynos
heroku ps:scale web=1

# Restart app
heroku restart
```

## Deploy to AWS

### Using AWS Elastic Beanstalk

1. **Install EB CLI**

```bash
pip install awsebcli
```

2. **Initialize EB**

```bash
eb init -p python-3.10 movie-recommendation
```

3. **Create Environment**

```bash
eb create movie-recommendation-env
```

4. **Configure `.ebextensions`**

Create `.ebextensions/django.config`:

```yaml
option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: movie_recommendation.wsgi:application
  aws:elasticbeanstalk:application:environment:
    DJANGO_SETTINGS_MODULE: movie_recommendation.settings
    PYTHONPATH: /var/app/current:$PYTHONPATH
    
container_commands:
  01_migrate:
    command: "source /var/app/venv/*/bin/activate && python manage.py migrate"
    leader_only: true
  02_collectstatic:
    command: "source /var/app/venv/*/bin/activate && python manage.py collectstatic --noinput"
    leader_only: true
```

5. **Deploy**

```bash
eb deploy
```

## Deploy with Docker

### Dockerfile

```dockerfile
FROM python:3.10-slim

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1

# Set work directory
WORKDIR /app

# Install dependencies
COPY requirements.txt .
RUN pip install --upgrade pip && \
    pip install -r requirements.txt

# Copy project
COPY . .

# Collect static files
RUN python manage.py collectstatic --noinput

# Expose port
EXPOSE 8000

# Run gunicorn
CMD ["gunicorn", "movie_recommendation.wsgi:application", "--bind", "0.0.0.0:8000"]
```

### docker-compose.yml

```yaml
version: '3.8'

services:
  web:
    build: .
    command: gunicorn movie_recommendation.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - .:/app
      - static_volume:/app/staticfiles
    ports:
      - "8000:8000"
    env_file:
      - .env
    depends_on:
      - db

  db:
    image: postgres:15
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=movie_recommendation
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - static_volume:/app/staticfiles
    ports:
      - "80:80"
    depends_on:
      - web

volumes:
  postgres_data:
  static_volume:
```

### Build and Run

```bash
# Build image
docker-compose build

# Run containers
docker-compose up -d

# Run migrations
docker-compose exec web python manage.py migrate

# View logs
docker-compose logs -f
```

## Database Configuration

### PostgreSQL Setup

```python
# settings.py
import dj_database_url

DATABASES = {
    'default': dj_database_url.config(
        default=os.environ.get('DATABASE_URL'),
        conn_max_age=600
    )
}
```

### Migrations

```bash
# Make migrations
python manage.py makemigrations

# Apply migrations
python manage.py migrate

# Create superuser (optional)
python manage.py createsuperuser
```

## Static Files

### WhiteNoise Configuration (Recommended)

Already configured in `settings.py`:

```python
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',  # Add this
    # ...
]

STORAGES = {
    "staticfiles": {
        "BACKEND": "whitenoise.storage.CompressedManifestStaticFilesStorage",
    },
}
```

### Collect Static Files

```bash
python manage.py collectstatic --noinput
```

## Environment Variables

### Required Variables

```env
SECRET_KEY=your-secret-key-minimum-50-characters
DEBUG=False
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com
DATABASE_URL=postgresql://user:pass@host:5432/dbname
```

### Optional Variables

```env
# CORS
CORS_ALLOWED_ORIGINS=https://yourdomain.com

# Admin
ADMIN_ENABLED=True

# Deployment
RENDER_EXTERNAL_HOSTNAME=your-app.onrender.com
```

### Generating Secret Key

```python
from django.core.management.utils import get_random_secret_key
print(get_random_secret_key())
```

## SSL/HTTPS Configuration

### Force HTTPS (Production)

In `settings.py`:

```python
if not DEBUG:
    SECURE_SSL_REDIRECT = True
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    SECURE_BROWSER_XSS_FILTER = True
    SECURE_CONTENT_TYPE_NOSNIFF = True
    X_FRAME_OPTIONS = 'DENY'
```

## Monitoring and Logging

### Setup Logging

```python
# settings.py
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'file': {
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': 'logs/django.log',
            'maxBytes': 1024 * 1024 * 5,  # 5 MB
            'backupCount': 5,
        },
    },
    'root': {
        'handlers': ['file'],
        'level': 'INFO',
    },
}
```

## Troubleshooting

### Common Issues

**Static files not loading:**
```bash
python manage.py collectstatic --noinput
# Check STATIC_ROOT and STATIC_URL in settings
```

**Database connection error:**
```bash
# Verify DATABASE_URL
echo $DATABASE_URL
# Check database is running
# Verify credentials
```

**Port already in use:**
```bash
# Find process using port
lsof -i :8000  # macOS/Linux
netstat -ano | findstr :8000  # Windows

# Kill process
kill -9 <PID>  # macOS/Linux
taskkill /PID <PID> /F  # Windows
```

**Module not found:**
```bash
pip install -r requirements.txt --upgrade
```

### Performance Optimization

1. **Enable caching**
2. **Use CDN for static files**
3. **Optimize database queries**
4. **Configure load balancing**
5. **Enable gzip compression**

## Security Checklist

- [ ] `DEBUG = False` in production
- [ ] Strong `SECRET_KEY` (50+ characters)
- [ ] HTTPS enabled
- [ ] Database credentials secured
- [ ] CORS properly configured
- [ ] Security headers enabled
- [ ] Regular security updates
- [ ] Input validation enabled
- [ ] Rate limiting configured

## Backup Strategy

```bash
# Backup database
pg_dump dbname > backup.sql

# Backup media files
tar -czf media_backup.tar.gz media/

# Restore database
psql dbname < backup.sql
```

---

## Need Help?

- **Documentation**: Check README.md
- **Issues**: Open a GitHub issue
- **Community**: Join discussions

Happy deploying! ðŸš€

